# General

FF.Lite -- легковесная версия FF.Multi для решений в области СКУД

## Delivery

Сборка FF.Lite представляет собой исполняемы файл `fflite-{cpu|gpu}-master-g{git_hash}.run`

`fflite-{cpu|gpu}-master-g{git_hash}.run` это self-extractable файл. В него входят:

* сам исполняемый файл, который отвечает за логику установщика
* сохраненные docker образы
* набор нейронных сетей (.fnk)
* файл docker-compose.yml
* файлы конфигураций (.ini, .yml, .conf)

Шаги для разворачивания FF.Lite:

* установить [Docker](https://docs.docker.com/engine/install/#server) (19.03+) и Compose (2.2.3+) через плагин (то есть Compose должен вызываться через `docker compose`)
* (для GPU версии) установить [NVIDIA Docker Runtime](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html)
* положить файл лицензии (*.lic) в директорию из которой запускается установщик
* отметить файл установщика, как исполняемый -- `chmod +x fflite-{cpu|gpu}-master-g{git_hash}.run`
* запустить установщик `sudo ./fflite-{cpu|gpu}-master-g{git_hash}.run` (использование `sudo` предпочтительно)
* следовать инструкциям установщика


## Документация

Начать ознакомление с API FF.Lite можно с интерактивной документации

Она находится по адресу `http://<hostname>/api-docs`

Документация предоставляет возможность чтения, создания, изменения и удаления всех сущностей
с описанием всех методов и параметров

Чтобы быстро проверить работоспособность системы можно создать камеру (`POST /v1/cameras/`).
При успешном создании и наличии людей/автомобилей в кадре, будут появляться события (`Event`).
В FF.Lite есть сущность карточки (`Card`) и сущность объекта (`Object`).
API позволяет создать карточку (`POST /v1/cards/`) и привязать к ней объект (`POST /v1/objects/`).
Для создания объекта необходимо изображение с детектируемым объектом.
Если после создания карточки привязанный объект появится в кадре, то созданное событие будет считаться сматченным.

Также FF.Lite позволяет обеспечить получение событий в сторонних системах через вебхуки (`Webhook`),
 для этого соответственно необходимо создать объект вебхука (`POST /v1/webhooks/`)


## Список сервисов

В порядке запуска

* ntls -- сервис лицензирования
* db -- база данных (Postgres)
* etcd -- in-memory хранилище (необходимо для VM)
* vm -- VideoManager
* vw -- VideoWorker
* eapi -- ExtractionApi
* api -- основной сервис, отвечающий за бизнес логику FF.Lite
* nginx -- веб-сервер


## Полезные команды

В редких случаях (например, слабое железо), некоторые сервисы могут не успеть стартануть за `start_period`,
тогда healthcheck не пройдет и контейнер не запустится. Если такое происходит, то имеет смысл попоробовать увеличить `start_period`
для соответствующего сервиса в docker-compose.yml

Если вы каким-либо образом меняете docker-compose файл, то необходимо погасить все контейнеры `docker compose down`, чтобы изменения вошли в силу
Если же вы меняете конфигурационные файлы (например vw.ini), то чтобы применить изменения достаточно перезагрузить соответствующий сервис (`docker compose restart vw`)

### Посмотреть логи

`docker compose logs --tail=1000` (логи всех сервисов)

`docker compose logs --tail=1000 api` (логи сервиса api)

если не указывать `--tail`, то напечатаются все доступные логи с самого начала, обычно это избыточно

### Посмотреть почему зафэйлился healthcheck

`docker inspect --format "{{json .State.Health }}" <container_name>` (container_name можно взять из `docker ps`)

### Манипуляции с сервисами

`docker compose stop nginx`

`docker compose restart eapi`

`docker compose exec -it /bin/bash` (зайти внутрь **работающего** контейнера)

`docker compose down` (завершить все сервисы)

`docker compose up -d` (запустить все сервисы в бэкграунде)

### Команды сервиса API

`docker compose exec api createuser` (создать пользователя)

`docker compose exec api deleteuser` (удалить пользователя)

`docker compose exec api cleanup` (удаление событий)
